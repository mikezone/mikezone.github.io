---
layout: cnblog_post
title: 线程与RunLoop
date: 2017-07-25T12:40:39.000Z
categories: iOS
---

http://blog.ibireme.com/2015/05/18/runloop/
http://www.cocoachina.com/ios/20161212/18335.html

http://www.jianshu.com/p/34c54bf80093

runloop、autorelease pool以及线程之间的关系
每个线程(包含主线程)都有一个Runloop。对于每一个Runloop，系统会隐式创建一个Autorelease pool，这样所有的release pool会构成一个像callstack一样的一个栈式结构，在每一个Runloop结束时，当前栈顶的Autorelease pool会被销毁，这样这个pool里的每个Object会被release。

RunLoop处理逻辑

通知Observer:即将进入Loop（1）
通知Observer：将要处理Timer（2）
通知Observer：将要处理Source0（3）
处理Source0（4）
如果有Source0，跳到第9步（5）
通知Observer：线程即将休眠（6）
休眠，等待唤醒：（7）
Source0(port)。
timer启动
RunLoop设置的timer已经超时
Runloop被外部手动唤醒
通知Observer：线程将被唤醒（8）
处理未处理的时间（9）
如果用户定义的定时器启动，处理定时器事件并重启Runloop。进入步骤2.
如果输入源启动，传递相应的消息。
如果RunLopp被显式唤醒而且时间还没超时，重启RunLoop，进入步骤2.
通知Observer：即将退出Loop

作者：微笑和飞飞
链接：http://www.jianshu.com/p/335a9b19adab
來源：简书
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

Runloop的应用:=----
NSTimer
ImageView显示
PerformSelector
常驻线程
自动释放池

autorelease 对象在什么情况下会被释放？-----------
分两种情况：手动干预释放和系统自动释放
手动干预释放就是指定autoreleasepool,当前作用域大括号结束就立即释放
系统自动去释放:不手动指定autoreleasepool,Autorelease对象会在当前的 runloop 迭代结束时释放
kCFRunLoopEntry(1):第一次进入会自动创建一个autorelease
kCFRunLoopBeforeWaiting(32):进入休眠状态前会自动销毁一个autorelease,然后重新创建一个新的autorelease
kCFRunLoopExit(128):退出runloop时会自动销毁最后一个创建的autorelease

在开发中如何使用RunLoop？什么应用场景？------------
开启一个常驻线程（让一个子线程不进入消亡状态，等待其他线程发来消息，处理其他事件）
在子线程中开启一个定时器
在子线程中进行一些长期监控
可以控制定时器在特定模式下执行
可以让某些事件（行为、任务）在特定模式下执行
可以添加Observer监听RunLoop的状态，比如监听点击事件的处理（在所有点击事件之前做一些事情）


https://www.baidu.com/s?ie=utf-8&f=8&rsv_bp=1&tn=baidu&wd=starming%20%E4%BD%BF%E7%94%A8NSOperation%20NSURLConnection%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B%E9%83%BD%E4%BC%9A%E9%9D%A2%E4%B8%B4%20&oq=%25E4%25BD%25BF%25E7%2594%25A8NSOperation%2520NSURL%2526lt%253Bonnection%25E5%25B9%25B6%25E5%258F%2591%25E6%25A8%25A1%25E5%259E%258B%25E9%2583%25BD%25E4%25BC%259A%25E9%259D%25A2%25E4%25B8%25B4&rsv_pq=de5fdd98000156a3&rsv_t=de19QUaeJl7%2BjQemzAPRNn7PORHpwIeDIC%2Bxd7RGV%2BWa5UqByoeSX7May6g&rqlang=cn&rsv_enter=1&rsv_sug3=19&rsv_sug2=0&inputT=6102&rsv_sug4=8103


http://www.jianshu.com/p/140643597652


http://blog.csdn.net/shaobo8910/article/details/47374735